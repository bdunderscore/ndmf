name: Auto-approve Copilot workflows

on:
  push:
    branches:
      - 'copilot/**'

permissions:
  actions: write
  contents: read
  pull-requests: read

jobs:
  auto-approve-copilot:
    name: Auto-approve Copilot workflows
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cancel previous workflow runs for this branch
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          CURRENT_RUN_ID=${{ github.run_id }}
          
          echo "Cancelling previous workflow runs for branch: $BRANCH_NAME"
          
          # Cancel previous runs of this workflow for the same branch
          gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.head_branch == "'"$BRANCH_NAME"'" and .workflow_id == '"${{ github.workflow }}"' and .status == "in_progress" and .id != '"$CURRENT_RUN_ID"') | .id' \
            | while read -r RUN_ID; do
                if [ -n "$RUN_ID" ]; then
                  echo "Cancelling previous auto-approve workflow run $RUN_ID"
                  gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/cancel --method POST || true
                fi
              done
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Find associated PR
        id: find-pr
        run: |
          # Get the branch name
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch: $BRANCH_NAME"
          
          # Find PR for this branch
          PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number // empty')
          
          if [ -z "$PR_NUMBER" ]; then
            echo "No open PR found for branch $BRANCH_NAME"
            echo "pr-found=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "Found PR #$PR_NUMBER"
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr-found=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Check PR author and files
        id: check-pr
        if: steps.find-pr.outputs.pr-found == 'true'
        run: |
          PR_NUMBER=${{ steps.find-pr.outputs.pr-number }}
          
          # Get PR details
          PR_AUTHOR=$(gh pr view "$PR_NUMBER" --json author --jq '.author.login')
          echo "PR Author: $PR_AUTHOR"
          
          # Check if author is GitHub Copilot bot
          if [[ "$PR_AUTHOR" != "copilot-swe-agent[bot]" ]] && [[ "$PR_AUTHOR" != "github-actions[bot]" ]]; then
            echo "PR is not from GitHub Copilot bot (author: $PR_AUTHOR)"
            echo "should-approve=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Get list of changed files
          CHANGED_FILES=$(gh pr view "$PR_NUMBER" --json files --jq '.files[].path')
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if any files under .github/ are modified
          if echo "$CHANGED_FILES" | grep -q "^\.github/"; then
            echo "PR modifies files under .github/ - not auto-approving for security"
            echo "should-approve=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "PR is safe to auto-approve"
          echo "should-approve=true" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Approve workflow runs
        if: steps.check-pr.outputs.should-approve == 'true'
        run: |
          PR_NUMBER=${{ steps.find-pr.outputs.pr-number }}
          
          # Get the workflow runs that need approval for this PR
          # We need to find workflow runs for the HEAD SHA of the PR
          PR_HEAD_SHA=$(gh pr view "$PR_NUMBER" --json headRefOid --jq '.headRefOid')
          echo "PR HEAD SHA: $PR_HEAD_SHA"
          
          # List workflow runs for this SHA that are waiting for approval
          WORKFLOW_RUNS=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.head_sha == "'"$PR_HEAD_SHA"'" and .status == "waiting") | .id')
          
          if [ -z "$WORKFLOW_RUNS" ]; then
            echo "No workflow runs waiting for approval"
            exit 0
          fi
          
          # Approve each waiting workflow run
          for RUN_ID in $WORKFLOW_RUNS; do
            echo "Approving workflow run $RUN_ID"
            gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/approve \
              --method POST || echo "Failed to approve run $RUN_ID (may already be approved)"
          done
          
          echo "Auto-approved workflow runs for PR #$PR_NUMBER"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Cancel previous workflow runs for copilot branch
        if: steps.find-pr.outputs.pr-found == 'true'
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          CURRENT_SHA=${{ github.sha }}
          
          echo "Cancelling previous workflow runs for copilot branch: $BRANCH_NAME"
          
          # Cancel previous workflow runs for this branch (except current SHA)
          # This saves CI resources by not running redundant builds
          gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs[] | select(.head_branch == "'"$BRANCH_NAME"'" and .head_sha != "'"$CURRENT_SHA"'" and (.status == "queued" or .status == "in_progress" or .status == "waiting")) | .id' \
            | while read -r RUN_ID; do
                if [ -n "$RUN_ID" ]; then
                  echo "Cancelling workflow run $RUN_ID for previous commit"
                  gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/cancel --method POST || true
                fi
              done
        env:
          GH_TOKEN: ${{ github.token }}